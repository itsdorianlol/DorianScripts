--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UIS = game:GetService("UserInputService")

local player = Players.LocalPlayer

local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "MainUtilityGUI"
gui.ResetOnSpawn = false

-- Variables
local floatActive = false
local floatBV
local beam, att0, att1
local beamUpdateConn
local espEnabled = false
local godModeEnabled = false
local tweenSpeed = 30 -- studs per second

-- Character & RootPart references (updated on spawn)
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")
local spawnPosition = rootPart.Position

-- Update character refs and spawnPosition on respawn
player.CharacterAdded:Connect(function(char)
	character = char
	rootPart = character:WaitForChild("HumanoidRootPart")
	spawnPosition = rootPart.Position
end)

-- Toggle Button
local toggleBtn = Instance.new("TextButton", gui)
toggleBtn.Size = UDim2.new(0, 45, 0, 45)
toggleBtn.Position = UDim2.new(0, 10, 0.5, -22)
toggleBtn.BackgroundColor3 = Color3.new(0, 0, 0)
toggleBtn.Text = "D"
toggleBtn.Font = Enum.Font.GothamBlack
toggleBtn.TextSize = 26
toggleBtn.TextColor3 = Color3.fromRGB(0, 102, 255)
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(1, 0)

-- Draggable UI function
local function makeDraggable(frame, handle)
	handle = handle or frame
	local dragging, dragInput, dragStart, startPos
	handle.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = frame.Position
			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then dragging = false end
			end)
		end
	end)
	handle.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
			dragInput = input
		end
	end)
	UIS.InputChanged:Connect(function(input)
		if input == dragInput and dragging then
			local delta = input.Position - dragStart
			frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end
	end)
end
makeDraggable(toggleBtn)

-- Main GUI
local main = Instance.new("Frame", gui)
main.Size = UDim2.new(0, 210, 0, 250)
main.Position = UDim2.new(0, 60, 0.5, -125)
main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
main.Visible = false
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 14)

local mainBar = Instance.new("Frame", main)
mainBar.Size = UDim2.new(1, 0, 0, 28)
mainBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Instance.new("UICorner", mainBar).CornerRadius = UDim.new(0, 14)

local title = Instance.new("TextLabel", mainBar)
title.Size = UDim2.new(1, -10, 1, 0)
title.Position = UDim2.new(0, 5, 0, 0)
title.Text = "Made by Dorian and ChatGPT"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.GothamBlack
title.TextSize = 15
title.BackgroundTransparency = 1
title.TextXAlignment = Enum.TextXAlignment.Left

makeDraggable(main, mainBar)

-- Create Main Buttons
local function createMainBtn(text, posY)
	local b = Instance.new("TextButton", main)
	b.Size = UDim2.new(1, -20, 0, 38)
	b.Position = UDim2.new(0, 10, 0, posY)
	b.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
	b.TextColor3 = Color3.new(1, 1, 1)
	b.Font = Enum.Font.Gotham
	b.TextSize = 20
	b.Text = text
	Instance.new("UICorner", b).CornerRadius = UDim.new(0, 8)
	return b
end

local stealBtn = createMainBtn("Steal", 40)
local espBtn = createMainBtn("ESP", 85)
local godBtn = createMainBtn("God Mode", 130)
local closeBtn = createMainBtn("Close", 175)
closeBtn.BackgroundColor3 = Color3.fromRGB(140, 20, 20)

-- Steal GUI
local steal = Instance.new("Frame", gui)
steal.Size = UDim2.new(0, 210, 0, 200)
steal.Position = UDim2.new(0, 280, 0.5, -100)
steal.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
steal.Visible = false
Instance.new("UICorner", steal).CornerRadius = UDim.new(0, 14)

local stealBar = Instance.new("Frame", steal)
stealBar.Size = UDim2.new(1, 0, 0, 28)
stealBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Instance.new("UICorner", stealBar).CornerRadius = UDim.new(0, 14)

local stealTitle = Instance.new("TextLabel", stealBar)
stealTitle.Size = UDim2.new(1, -10, 1, 0)
stealTitle.Position = UDim2.new(0, 5, 0, 0)
stealTitle.Text = "Steal Controls"
stealTitle.TextColor3 = Color3.new(1,1,1)
stealTitle.Font = Enum.Font.GothamBlack
stealTitle.TextSize = 15
stealTitle.BackgroundTransparency = 1
stealTitle.TextXAlignment = Enum.TextXAlignment.Left

makeDraggable(steal, stealBar)

-- Steal Buttons
local function createStealBtn(text, posY)
	local b = Instance.new("TextButton", steal)
	b.Size = UDim2.new(1, -20, 0, 40)
	b.Position = UDim2.new(0, 10, 0, posY)
	b.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
	b.TextColor3 = Color3.new(1, 1, 1)
	b.Font = Enum.Font.Gotham
	b.TextSize = 20
	b.Text = text
	Instance.new("UICorner", b).CornerRadius = UDim.new(0, 8)
	return b
end

local floatBtn = createStealBtn("Float", 40)
local skyBtn = createStealBtn("Sky", 90)
-- ground button removed

-- God Mode
local function enableGodMode()
	local hum = character and character:FindFirstChildOfClass("Humanoid")
	if hum then
		hum.Health = hum.MaxHealth
		hum:GetPropertyChangedSignal("Health"):Connect(function()
			if godModeEnabled then
				hum.Health = hum.MaxHealth
			end
		end)
	end
end

godBtn.MouseButton1Click:Connect(function()
	godModeEnabled = not godModeEnabled
	godBtn.BackgroundColor3 = godModeEnabled and Color3.fromRGB(0,170,0) or Color3.fromRGB(70,70,70)
	if godModeEnabled then enableGodMode() end
end)

-- Float
floatBtn.MouseButton1Click:Connect(function()
	if not character or not rootPart then return end

	floatActive = not floatActive
	floatBtn.BackgroundColor3 = floatActive and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(70, 70, 70)

	if floatActive then
		floatBV = Instance.new("BodyVelocity")
		floatBV.Velocity = Vector3.new(0, 15, 0)
		floatBV.MaxForce = Vector3.new(0, math.huge, 0)
		floatBV.Parent = rootPart

		task.spawn(function()
			while floatActive and rootPart and rootPart.Parent do
				RunService.Heartbeat:Wait()
				local rayOrigin = rootPart.Position + Vector3.new(0, 2, 0)
				local rayDirection = Vector3.new(0, 3, 0)
				local rayParams = RaycastParams.new()
				rayParams.FilterDescendantsInstances = {character}
				rayParams.FilterType = Enum.RaycastFilterType.Blacklist

				local result = workspace:Raycast(rayOrigin, rayDirection, rayParams)
				if result then
					floatBV.Velocity = Vector3.new(0, 0, 0)
				else
					floatBV.Velocity = Vector3.new(0, 15, 0)
				end
			end
			if floatBV then floatBV:Destroy() end
		end)
	else
		if floatBV then floatBV:Destroy() end
	end
end)

-- Sky Teleport (updated to wait 1 second after teleport up)
skyBtn.MouseButton1Click:Connect(function()
	if not character or not rootPart then return end

	-- Step 1: teleport 150 studs up instantly
	rootPart.CFrame = rootPart.CFrame + Vector3.new(0, 150, 0)

	-- Step 2: wait 1 second before tweening
	task.wait(1)

	local currentPos = rootPart.Position

	-- Step 3: tween horizontally to saved X,Z keeping current Y
	local tweenTarget = Vector3.new(spawnPosition.X, currentPos.Y, spawnPosition.Z)

	local distance = (rootPart.Position - tweenTarget).Magnitude
	local speed = tweenSpeed
	local duration = distance / speed

	local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut)
	local tweenGoal = {CFrame = CFrame.new(tweenTarget)}
	local tween = TweenService:Create(rootPart, tweenInfo, tweenGoal)
	tween:Play()
	tween.Completed:Wait()

	-- Step 4: teleport down to original spawn Y level
	rootPart.CFrame = CFrame.new(spawnPosition)
end)

-- ESP Logic
local highlightFolder = Instance.new("Folder", gui)
highlightFolder.Name = "ESPFolder"

local function createESP(char)
	if highlightFolder:FindFirstChild(char.Name) then return end
	local h = Instance.new("Highlight")
	h.Name = char.Name
	h.FillColor = Color3.new(1, 0, 0)
	h.OutlineColor = Color3.new(0, 0, 0)
	h.Adornee = char
	h.Parent = highlightFolder

	local head = char:FindFirstChild("Head")
	if head then
		local tag = Instance.new("BillboardGui", h)
		tag.Adornee = head
		tag.Size = UDim2.new(0, 100, 0, 25)
		tag.StudsOffset = Vector3.new(0, 2, 0)
		tag.AlwaysOnTop = true

		local label = Instance.new("TextLabel", tag)
		label.Size = UDim2.new(1, 0, 1, 0)
		label.BackgroundTransparency = 1
		label.Text = char.Name
		label.TextColor3 = Color3.new(1, 1, 1)
		label.TextSize = 14
		label.Font = Enum.Font.GothamBlack
		label.TextStrokeTransparency = 0
	end
end

local function refreshESP()
	highlightFolder:ClearAllChildren()
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= player and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			createESP(plr.Character)
		end
	end
end

espBtn.MouseButton1Click:Connect(function()
	espEnabled = not espEnabled
	espBtn.BackgroundColor3 = espEnabled and Color3.fromRGB(0,170,0) or Color3.fromRGB(70,70,70)
	if espEnabled then
		refreshESP()
	else
		highlightFolder:ClearAllChildren()
	end
end)

task.spawn(function()
	while true do
		task.wait(10)
		if espEnabled then refreshESP() end
	end
end)

-- GUI toggles
toggleBtn.MouseButton1Click:Connect(function()
	main.Visible = not main.Visible
end)

stealBtn.MouseButton1Click:Connect(function()
	steal.Visible = not steal.Visible
end)

closeBtn.MouseButton1Click:Connect(function()
	main.Visible = false
end)
